# PolyMusic
Курсовой проект по программированию на C++ 
## Введение
Недавно разработчики социальной сети ВКонтакте решили ограничить открытый доступ к аудиозаписям: после прослушивания музыки в фоновом режиме в течение получаса она автоматически останавливается - всплывает сообщение с предложением купить подписку на месяц. Этот факт огорчил меня, потому что бесплатная музыка – это то, за что многие любят сайт ВКонтакте. Тогда я поставила перед собой задачу сделать Telegram бота для прослушивания своего музыкального плейлиста ВКонтакте. Оказалось, что сделать это не так просто, ведь разработчики закрыли публичный доступ к методам VK API, которые позволяли взаимодействовать с аудиозаписями. Мало того, если раньше в исходном коде страницы http://vk.com/audio (это и есть музыкальный плейлист) можно было найти ссылки на все mp3 файлы с добавленными треками, то сейчас в веб-версии сайта они пропали вовсе, а в мобильной версии представлены в виде зашифрованных ссылок. Я начала искать способ для обхода этих ограничений. Спустя время, я поняла, что решение проблемы лежит на поверхности: помимо стандартных методов для взаимодействия с аккаунтом пользователя, в VK API существует метод “execute” - это универсальный метод, который позволяет стороннему разработчику запускать последовательность других методов. Я попробовала запустить самый простой метод для получения музыки ВКонтакте через execute и, к моему удивлению, никаких ошибок доступа не возникло! Таким образом я научилась получать всю информацию об аудиозаписях пользователя.

## Техническое задание
Создать Telegram бота, который смог бы авторизовать пользователя при помощи его логина и пароля ВКонтакте, а затем дать доступ к безлимитному прослушиванию музыкального плейлиста пользователя и, в случае необходимости, синхронизовать изменения этого плейлиста.

## Алгоритмы
Сначала мне понадобилось реализовать алгоритм прямой авторизации через ВКонтакте. Для этого я деалю post-запрос на https://vk.com и таким образом получаю cookies, хранящаяся в заголовках, а также исходный код главной страницы; При помощи регулярных выражений извлекаю из него параметры “ip_h” и “lg_h”. Теперь можно авторизоваться, сделав post-запрос на https://login.vk.com/?act=login, где в качестве параметров будут логин и пароль пользователя, те два параметра, которые мы получили на предыдущем этапе и ещё некоторые менее интересные параметры. Если всё сделано правильно, то в ответ нам придёт ссылка для редиректа на страницу пользователя. Делаем post-запрос на этот адрес и получаем cookies, которые уже запоминаем, ведь они понадобятся для того, чтобы совершать все дальнейшие действия через аккаунт пользователя, а также id пользователя ВКонтакте.

Затем я реализовала алгоритм получения информации об аудиозаписях пользователя. Сперва я делаю post-запрос на https://vk.com/dev/execute, чтобы в результате узнать хеш-параметр, который понадобится мне для запуска метода execute. Затем делаю post-запрос на https://vk.com/dev.php, где в параметрах указываю полученный хеш; код, в котором указываю, какой именно метод VK API нам нужно вызвать (return API.audio.get()) и ещё несколько параметров. Если всё сделано правильно, то в ответ придёт информация о каждом треке в плейлисте пользователя.

Для реализации этих алгоритмов мне понадобились библиотеки libcurl (для создания post-запросов), iconvpp (для изменения кодировки), json (для разбора ответов VK API в формате JSON) – все они свободно распространяются в Интернете. Также использовалась стандартная библиотека regex (для регулярных выражения).

## Описание классов
Пользователь программы описывается при помощи класса User, который хранит в себе id в Telegram (tg_id_); id во ВКонтакте (vk_id_); cookies, необходимые для взаимодействия с ВКонтакте – они действительны год и привязываются к ip адресу компьютера, на котором запускается программа; вектор из id аудиозаписей (audio_), которые находятся в плейлисте пользователя. Все эти поля синхронизируются с базой данных. В качестве базы данных я выбрал PostgreSQL - для взаимодействия с ней подключил библиотеку libpqxx.

Для того, чтобы настроить взаимодействие с Telegram API я использовала библиотеку TgBot. Сам бот описывается классом Bot. Логично было бы наследоваться от этого класса и уже в наследнике хранить массив из id пользователей программы, но сейчас я просто создаю объект класса Bot в функции main() и передаю его тем методам пользователя, которые в этом нуждаются.

## Схематичное изображение работы программы

![Scheme of the Program](https://pp.userapi.com/c846420/v846420006/89766/gLoPMopkWE0.jpg)

Здесь я попыталась изобразить, как объект класса User взаимодействует с другими сущностями в программе посредством своих основных методов.

Помимо этого, у меня есть пространство имён HttpClient, куда я поместила функции для создания запросов к сторонним серверам, формирования строки с параметрами для этих запросов, кодирования строк, парсинга cookies и сохранения файла (эта функция понадобится в том случае, если размер аудиофайла будет превышать 20 Мб – Telegram API не разрешает отправлять такие аудиофайлы напрямую по ссылке).

## Выводы
Могу отметить, что это был очень интересный опыт разработки, потому что никогда до этого я не реализовывала прямую авторизацию через ВКонтакте на языке C++ и не писала ботов для Telegram, из-за чего у меня и возникли некоторые проблемы. Во первых, я не разобралась, каким образом бот может ожидать логин и пароль пользователя, поэтому сейчас он заточен только под одного пользователя ВКонтакте. Во-вторых, наблюдается “аномальный баг” с названиями треков и именами исполнителей: они, не являясь пустыми строками, передаются в функцию с говорящим названием sendAudio(url, artist, title), а в Telegram приходят безымянными. Соответственно, поставленная задача не достигнута в полной мере – проект выполнен примерно на 80 процентов.

Стоит добавить, что здесь я использую баг ВКонтакте, ведь на самом деле никто со стороны не должен иметь доступ к музыке на сайте. В любой момент разработчики социальной сети могут пофиксить это и моя программа перестанет работать.

**19.12.2019**
